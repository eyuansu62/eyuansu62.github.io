function now(){return Date.now()}async function myMemoryTranslate(e,{from:t="en",to:n=TARGET_LANG_GOOGLE}={}){const a=stableTrim(e);if(!a)return"";const r=`${t}|${n}|${a}`;if(translationCache.has(r))return translationCache.get(r);const s=`${MYMEMORY_ENDPOINT}?q=${encodeURIComponent(a)}&langpair=${encodeURIComponent(t)}|${encodeURIComponent(n)}`,o=await fetch(s,{method:"GET"});if(!o.ok)throw new Error(`Translate failed (HTTP ${o.status})`);const i=await o.json(),d=i?.responseData?.translatedText;if("string"!=typeof d)throw new Error("Translate failed (no text)");const l=stableTrim(d);if(!l)throw new Error("Translate failed (empty)");if(/REQUEST LIMIT/i.test(l)||/MYMEMORY WARNING/i.test(l))throw new Error(l);return translationCache.set(r,l),l}async function runTranslateTask(e){if(translateBusy)setStatus("Translation already running... please wait.");else{translateBusy=!0;try{await e()}finally{translateBusy=!1}}}function clamp(e,t,n){return Math.max(t,Math.min(n,e))}function stableTrim(e){return String(e??"").replace(/\r\n/g,"\n").trim()}function normalizeApostrophes(e){return String(e??"").replace(/[\u2018\u2019]/g,"'")}function normalizeWord(e){let t=normalizeApostrophes(e).toLowerCase();return t=t.replace(/^'+|'+$/g,""),t}function extractWords(e){return(normalizeApostrophes(e).match(/[A-Za-z]+(?:'[A-Za-z]+)*/g)||[]).map(normalizeWord).filter(Boolean)}function guessPos(e){return e.endsWith("ly")?"adv?":/(tion|ment|ness|ity|ship|ism|ance|ence)$/.test(e)?"noun?":/(ous|ful|able|ible|ive|al|ic|less)$/.test(e)?"adj?":/(ate|ify|ise|ize|en)$/.test(e)?"verb?":""}function suggestWords(e){const t=extractWords(e),n=new Set,a=[];for(const e of t)if(!n.has(e)&&(n.add(e),!STOPWORDS.has(e)&&!(e.length<4)&&(a.push(e),a.length>=MAX_SUGGESTED_WORDS)))break;return a}function formatDate(e){const t=new Date(e);return new Intl.DateTimeFormat(void 0,{year:"numeric",month:"short",day:"2-digit"}).format(t)}function relDays(e){const t=e-now();return Math.round(t/DAY_MS)}function buildGoogleTranslateUrl(e,{sl:t="en",tl:n=TARGET_LANG_GOOGLE}={}){const a=encodeURIComponent(String(e??""));return`https://translate.google.com/?sl=${encodeURIComponent(t)}&tl=${encodeURIComponent(n)}&text=${a}&op=translate`}function buildBingTranslateUrl(e,{from:t="en",to:n=TARGET_LANG_BING}={}){const a=encodeURIComponent(String(e??""));return`https://www.bing.com/translator?from=${encodeURIComponent(t)}&to=${encodeURIComponent(n)}&text=${a}`}function buildCambridgeEnZhUrl(e){return`https://dictionary.cambridge.org/dictionary/english-chinese-simplified/${encodeURIComponent(String(e??""))}`}function openExternal(e){try{window.open(e,"_blank","noopener,noreferrer")}catch{location.href=e}}function fmtDue(e){const t=relDays(e);return 0===t?`today (${formatDate(e)})`:1===t?`tomorrow (${formatDate(e)})`:-1===t?`yesterday (${formatDate(e)})`:t<0?`${Math.abs(t)}d overdue (${formatDate(e)})`:`in ${t}d (${formatDate(e)})`}function shuffleInPlace(e){for(let t=e.length-1;t>0;t-=1){const n=Math.floor(Math.random()*(t+1));[e[t],e[n]]=[e[n],e[t]]}}function newId(){return globalThis.crypto?.randomUUID?globalThis.crypto.randomUUID():`id_${Math.random().toString(16).slice(2)}_${Date.now().toString(16)}`}function defaultSrs(){return{dueAt:now(),intervalDays:0,ease:2.5,reps:0,lapses:0,lastReviewedAt:0,lastQuality:0}}function updateSm2(e,t){let n="number"==typeof e.ease?e.ease:2.5,a="number"==typeof e.reps?e.reps:0,r="number"==typeof e.intervalDays?e.intervalDays:0,s="number"==typeof e.lapses?e.lapses:0;return t<3?(a=0,r=1,s+=1):(a+=1,r=1===a?1:2===a?6:Math.max(1,Math.round(r*n))),n+=.1-(5-t)*(.08+.02*(5-t)),n=Math.max(1.3,n),{dueAt:now()+r*DAY_MS,intervalDays:r,ease:n,reps:a,lapses:s,lastReviewedAt:now(),lastQuality:t}}function emptyState(){return{version:1,cards:[],lexicon:{}}}function loadState(){try{const e=localStorage.getItem(STORAGE_KEY);if(!e)return emptyState();const t=JSON.parse(e);if(!t||"object"!=typeof t)return emptyState();const n=Array.isArray(t.cards)?t.cards:[],a=t.lexicon&&"object"==typeof t.lexicon?t.lexicon:{};return{version:1,cards:n.filter(e=>e&&"object"==typeof e).map(normalizeCard),lexicon:normalizeLexicon(a)}}catch{return emptyState()}}function saveState(){try{localStorage.setItem(STORAGE_KEY,JSON.stringify(state)),setStatus(`Saved. Cards: ${state.cards.length}. Words: ${Object.keys(state.lexicon).length}.`)}catch(e){setStatus("Save failed (localStorage quota?). Export a backup and clear space.","danger")}}function normalizeLexicon(e){const t={};for(const[n,a]of Object.entries(e)){const e=normalizeWord(n);if(!e)continue;if(!a||"object"!=typeof a)continue;const r=stableTrim(a.translation??a.t??""),s=stableTrim(a.notes??a.n??""),o=Number(a.updatedAt??a.u??0)||0;t[e]={translation:r,notes:s,updatedAt:o}}return t}function normalizeCard(e){const t="string"==typeof e.id&&e.id?e.id:newId(),n=stableTrim(e.sentence??e.s??""),a=stableTrim(e.source??""),r=stableTrim(e.translation??e.tr??""),s=stableTrim(e.notes??""),o=Array.isArray(e.targets)?e.targets:Array.isArray(e.words)?e.words:[],i=[],d=new Set;for(const e of o){const t=normalizeWord(e);t&&!d.has(t)&&(d.add(t),i.push(t))}const l=Number(e.createdAt??e.c??0)||now(),c=Number(e.updatedAt??e.u??0)||l,u=e.srs&&"object"==typeof e.srs?e.srs:defaultSrs();return{id:t,sentence:n,source:a,translation:r,notes:s,targets:i,createdAt:l,updatedAt:c,srs:{...defaultSrs(),...u,dueAt:Number(u.dueAt??u.d??now())||now(),intervalDays:Number(u.intervalDays??u.i??0)||0,ease:Number(u.ease??u.e??2.5)||2.5,reps:Number(u.reps??u.r??0)||0,lapses:Number(u.lapses??u.l??0)||0,lastReviewedAt:Number(u.lastReviewedAt??u.lr??0)||0,lastQuality:Number(u.lastQuality??u.lq??0)||0}}}function byId(e){return state.cards.find(t=>t.id===e)||null}function upsertLexicon(e,t,n=""){const a=normalizeWord(e);if(!a)return;const r=stableTrim(t),s=stableTrim(n);if(!r&&!s)return;const o=state.lexicon[a]||{translation:"",notes:"",updatedAt:0};state.lexicon[a]={translation:r||o.translation,notes:s||o.notes,updatedAt:now()}}function getDueCards(){return state.cards.filter(e=>(e.srs?.dueAt??0)<=now()).sort((e,t)=>e.srs.dueAt-t.srs.dueAt)}function domainFromUrl(e){try{return new URL(e).hostname.replace(/^www\./,"")}catch{return""}}function setStatus(e,t="normal"){const n=$("#footerStatus");n&&(n.textContent=e,n.style.color="danger"===t?"#7a271a":"")}function setRoute(e,t=!0){const n=ROUTES.includes(e)?e:"capture";for(const e of document.querySelectorAll(".view"))e.classList.toggle("active",e.dataset.view===n);for(const e of document.querySelectorAll(".tab"))e.classList.toggle("active",e.dataset.route===n);t&&(location.hash=n),"deck"===n?(renderDeck(),renderLexicon()):"review"===n&&(renderReviewStats(),renderReview())}function currentRoute(){const e=(location.hash||"").replace(/^#/,"");return ROUTES.includes(e)?e:"capture"}function splitLines(e){return stableTrim(e).split("\n").map(e=>e.trim()).filter(Boolean)}function resetCaptureDraft(){captureDraft={},captureManualOrder=[],renderSuggestedWords()}function setCaptureWord(e,t){const n=normalizeWord(e);if(!n)return;const a=captureDraft[n]||{checked:!0,translation:"",manual:!1};captureDraft[n]={...a,...t}}function rebuildSuggestionsFromSentence({keepTranslations:e=!0}={}){const t=suggestWords(stableTrim($("#captureSentence").value));for(const[e,n]of Object.entries(captureDraft))n.manual||t.includes(e)||delete captureDraft[e];for(const n of t){const t=captureDraft[n],a=state.lexicon[n]?.translation||"";t?e&&!t.translation&&a&&(t.translation=a):captureDraft[n]={checked:!0,translation:a,manual:!1}}renderSuggestedWords()}function renderSuggestedWords(){const e=$("#suggestedWords");e.textContent="";const t=[...suggestWords(stableTrim($("#captureSentence").value)),...captureManualOrder.filter(e=>captureDraft[e]?.manual)];if(0===t.length){const t=document.createElement("div");return t.className="panel-sub",t.textContent="Type a sentence to see suggested words.",void e.appendChild(t)}for(const n of t){const t=captureDraft[n]||{checked:!0,translation:"",manual:!1},a=document.createElement("div");a.className="word-row";const r=document.createElement("input");r.type="checkbox",r.checked=!!t.checked,r.dataset.word=n,r.className="word-check";const s=document.createElement("div"),o=document.createElement("div");o.className="w",o.textContent=n;const i=document.createElement("div");i.className="meta";const d=[guessPos(n),state.lexicon[n]?.translation?"lex":"",t.manual?"manual":""].filter(Boolean).join(" ");i.textContent=d||" ";const l=document.createElement("div");l.className="mini-links";const c=document.createElement("a");c.className="mini-link",c.href=buildCambridgeEnZhUrl(n),c.target="_blank",c.rel="noopener noreferrer",c.textContent="Cambridge";const u=document.createElement("a");u.className="mini-link",u.href=buildGoogleTranslateUrl(n,{sl:"en",tl:TARGET_LANG_GOOGLE}),u.target="_blank",u.rel="noopener noreferrer",u.textContent="Translate",l.appendChild(c),l.appendChild(u),s.appendChild(o),s.appendChild(i),s.appendChild(l);const m=document.createElement("input");m.type="text",m.placeholder="translation (optional)",m.value=t.translation||"",m.dataset.word=n,m.className="word-translation",a.appendChild(r),a.appendChild(s),a.appendChild(m),e.appendChild(a)}}function collectCaptureTargets(){const e=[];for(const[t,n]of Object.entries(captureDraft))n.checked&&e.push(t);return[...suggestWords(stableTrim($("#captureSentence").value)),...captureManualOrder].filter(t=>e.includes(t))}function createCard({sentence:e,source:t,translation:n,notes:a,targets:r}){const s=Array.isArray(r)?r.map(normalizeWord).filter(Boolean):[],o=new Set,i=[];for(const e of s)o.has(e)||(o.add(e),i.push(e));return normalizeCard({id:newId(),sentence:e,source:t,translation:n,notes:a,targets:i,createdAt:now(),updatedAt:now(),srs:defaultSrs()})}function loadSampleDeckIntermediate(){if(!confirm("Load 50 sample cards (intermediate) into your deck? This will not delete existing cards."))return;const e=new Set(state.cards.map(e=>stableTrim(normalizeApostrophes(e.sentence)).toLowerCase()));let t=0,n=0;for(let a=SAMPLE_SENTENCES_INTERMEDIATE_V1.length-1;a>=0;a-=1){const r=SAMPLE_SENTENCES_INTERMEDIATE_V1[a],s=stableTrim(normalizeApostrophes(r)).toLowerCase();if(!s)continue;if(e.has(s)){n+=1;continue}const o=createCard({sentence:r,source:"",translation:"",notes:"",targets:suggestWords(r)});state.cards.unshift(o),e.add(s),t+=1}saveState(),renderAll(),setStatus(`Loaded sample deck. Added ${t}, skipped ${n}.`)}function captureSaveCards(e){e.preventDefault();const t=stableTrim($("#captureSentence").value),n=stableTrim($("#captureSource").value),a=stableTrim($("#captureTranslation").value),r=stableTrim($("#captureNotes").value),s=!!$("#captureBulk").checked;if(!t)return void setStatus("Nothing to save. Paste a sentence first.","danger");if(s){const e=splitLines(t);if(0===e.length)return void setStatus("Nothing to save.","danger");let a=0;for(const t of e){const e=createCard({sentence:t,source:n,translation:"",notes:"",targets:suggestWords(t)});state.cards.unshift(e),a+=1}return saveState(),setStatus(`Saved ${a} cards (one per line).`),void clearCaptureForm()}const o=collectCaptureTargets();for(const e of o){const t=stableTrim(captureDraft[e]?.translation||"");t&&upsertLexicon(e,t)}const i=createCard({sentence:t,source:n,translation:a,notes:r,targets:o});state.cards.unshift(i),saveState(),setStatus(`Saved 1 card. Target words: ${o.length}.`),clearCaptureForm()}function clearCaptureForm(){$("#captureSentence").value="",$("#captureSource").value="",$("#captureTranslation").value="",$("#captureNotes").value="",$("#captureBulk").checked=!1,resetCaptureDraft()}function renderReviewStats(){const e=getDueCards(),t=state.cards.length,n=state.cards.slice().sort((e,t)=>e.srs.dueAt-t.srs.dueAt).find(e=>e.srs.dueAt>now()),a=[];a.push(`Due now: ${e.length} / ${t}`),n&&a.push(`Next due: ${fmtDue(n.srs.dueAt)} (${n.sentence.slice(0,60)}${n.sentence.length>60?"...":""})`),$("#reviewStats").textContent=a.join("\n")}function startReview({shuffle:e=!1}={}){const t=getDueCards();if(0===t.length)return reviewSession=null,renderReview(),void setStatus("No cards due. Capture more, or wait until something is due.");const n=t.map(e=>e.id);e&&shuffleInPlace(n),reviewSession={queue:n,idx:0,revealed:!1,shuffled:e},renderReview()}function currentReviewCard(){if(!reviewSession)return null;return byId(reviewSession.queue[reviewSession.idx])}function renderReview(){const e=$("#reviewSentence"),t=$("#reviewMeta"),n=$("#reviewAnswer"),a=$("#reviewGrade"),r=$("#reviewProgress"),s=$("#reviewReveal");s.disabled=!0,n.classList.add("hidden"),a.classList.add("hidden");const o=currentReviewCard();if(!o)return e.textContent="No card loaded.",t.textContent="",void(r.textContent=reviewSession?"Review finished.":"Press Start Review to begin.");e.textContent=o.sentence||"(empty)";const i=o.source?domainFromUrl(o.source):"";t.textContent=[`due: ${fmtDue(o.srs.dueAt)}`,`interval: ${o.srs.intervalDays}d`,`ease: ${o.srs.ease.toFixed(2)}`,`targets: ${o.targets.length}`,i?`source: ${i}`:""].filter(Boolean).join("  |  "),$("#reviewTranslationBlock").style.display=o.translation?"":"none",$("#reviewNotesBlock").style.display=o.notes?"":"none",$("#reviewWordsBlock").style.display=o.targets.length?"":"none",$("#reviewTranslation").textContent=o.translation||"",$("#reviewNotes").textContent=o.notes||"";const d=$("#reviewWords");d.textContent="";for(const e of o.targets){const t=document.createElement("div");t.className="worditem";const n=document.createElement("div");n.className="left",n.textContent=e;const a=document.createElement("div");a.className="right";const r=state.lexicon[e]?.translation||"",s=document.createElement("div");s.textContent=r||"(no translation yet)";const o=document.createElement("div");o.className="mini-links";const i=document.createElement("a");i.className="mini-link",i.href=buildCambridgeEnZhUrl(e),i.target="_blank",i.rel="noopener noreferrer",i.textContent="Cambridge";const l=document.createElement("a");l.className="mini-link",l.href=buildGoogleTranslateUrl(e,{sl:"en",tl:TARGET_LANG_GOOGLE}),l.target="_blank",l.rel="noopener noreferrer",l.textContent="Translate",o.appendChild(i),o.appendChild(l),a.appendChild(s),a.appendChild(o),t.appendChild(n),t.appendChild(a),d.appendChild(t)}s.disabled=!1,r.textContent=`Card ${reviewSession.idx+1} / ${reviewSession.queue.length}`,reviewSession?.revealed&&(n.classList.remove("hidden"),a.classList.remove("hidden"))}function revealAnswer(){if(!reviewSession)return;currentReviewCard()&&(reviewSession.revealed=!0,$("#reviewAnswer").classList.remove("hidden"),$("#reviewGrade").classList.remove("hidden"))}function gradeCurrent(e){const t=currentReviewCard();if(!reviewSession||!t)return;if(!reviewSession.revealed)return;const n={again:2,hard:3,good:4,easy:5}[e];if(n){if(t.srs=updateSm2(t.srs,n),t.updatedAt=now(),saveState(),reviewSession.idx+=1,reviewSession.revealed=!1,reviewSession.idx>=reviewSession.queue.length)return reviewSession=null,renderReviewStats(),renderReview(),void setStatus("Review finished.");renderReviewStats(),renderReview()}}function setDeckDueOnly(e){deckDueOnly=!!e,renderDeck()}function renderDeck(){const e=$("#deckList");e.textContent="";const t=stableTrim($("#deckSearch").value).toLowerCase(),n=deckDueOnly,a=state.cards.slice().sort((e,t)=>e.srs.dueAt-t.srs.dueAt).filter(e=>{if(n&&e.srs.dueAt>now())return!1;if(!t)return!0;return`${e.sentence}\n${e.translation}\n${e.notes}\n${e.source}`.toLowerCase().includes(t)});if(0===a.length){const t=document.createElement("div");return t.className="panel-sub",t.textContent=n?"No due cards match your filter.":"No cards match your filter.",void e.appendChild(t)}for(const t of a){const n=document.createElement("div");n.className="deck-item",n.dataset.id=t.id;const a=document.createElement("div");a.className="sentence",a.textContent=t.sentence||"(empty)";const r=document.createElement("div");r.className="meta";const s=t.source?domainFromUrl(t.source):"";r.textContent=[`due: ${fmtDue(t.srs.dueAt)}`,`int: ${t.srs.intervalDays}d`,`ease: ${t.srs.ease.toFixed(2)}`,`targets: ${t.targets.length}`,s?`src: ${s}`:""].filter(Boolean).join("  |  ");const o=document.createElement("div");o.className="actions";const i=document.createElement("button");i.className="btn",i.type="button",i.dataset.action="edit",i.textContent="Edit";const d=document.createElement("button");d.className="btn primary",d.type="button",d.dataset.action="reviewNow",d.textContent="Review Now";const l=document.createElement("button");l.className="btn danger",l.type="button",l.dataset.action="delete",l.textContent="Delete",o.appendChild(i),o.appendChild(d),o.appendChild(l),n.appendChild(a),n.appendChild(r),n.appendChild(o),e.appendChild(n)}}function renderLexicon(){const e=$("#lexList");e.textContent="";const t=stableTrim($("#lexSearch").value).toLowerCase(),n=Object.entries(state.lexicon).map(([e,t])=>({w:e,...t})).filter(e=>!t||(e.w.includes(t)||(e.translation||"").toLowerCase().includes(t))).sort((e,t)=>e.w.localeCompare(t.w));if(0===n.length){const t=document.createElement("div");return t.className="panel-sub",t.textContent="No saved words yet. Add translations in Capture or Edit.",void e.appendChild(t)}for(const t of n){const n=document.createElement("div");n.className="lex-item";const a=document.createElement("div");a.className="w",a.textContent=t.w;const r=document.createElement("div");r.className="t",r.textContent=t.translation||"",n.appendChild(a),n.appendChild(r),e.appendChild(n)}}function download(e,t,n="application/octet-stream"){const a=new Blob([t],{type:n}),r=URL.createObjectURL(a),s=document.createElement("a");s.href=r,s.download=e,document.body.appendChild(s),s.click(),s.remove(),URL.revokeObjectURL(r)}function exportJson(){const e={exportedAt:now(),version:1,cards:state.cards,lexicon:state.lexicon};download(`sentence-cards-backup-${new Date(now()).toISOString().slice(0,10)}.json`,JSON.stringify(e,null,2),"application/json"),setStatus("Exported backup JSON.")}function exportLexiconCsv(){const e=[["word","translation"]],t=Object.entries(state.lexicon).sort((e,t)=>e[0].localeCompare(t[0]));for(const[n,a]of t)e.push([n,a.translation||""]);download("lexicon.csv",e.map(e=>e.map(e=>{const t=String(e??"");return/[,"\n]/.test(t)?`"${t.replace(/"/g,'""')}"`:t}).join(",")).join("\n"),"text/csv"),setStatus("Exported lexicon CSV.")}function importJsonRun(){const e=$("#importFile").files?.[0];if(!e)return void setStatus("Choose a JSON file first.","danger");const t=document.querySelector('input[name="importMode"]:checked')?.value||"merge",n=new FileReader;n.onerror=()=>setStatus("Failed to read file.","danger"),n.onload=()=>{try{const e=JSON.parse(String(n.result||"")),a=Array.isArray(e.cards)?e.cards.map(normalizeCard):[],r=normalizeLexicon(e.lexicon||{});if("replace"===t)state={version:1,cards:a,lexicon:r};else{const e=new Set(state.cards.map(e=>e.id));for(const t of a)e.has(t.id)&&(t.id=newId()),state.cards.push(t),e.add(t.id);for(const[e,t]of Object.entries(r)){const n=state.lexicon[e];n?!stableTrim(n.translation)&&stableTrim(t.translation)&&(state.lexicon[e]={...n,translation:t.translation,updatedAt:now()}):state.lexicon[e]=t}}saveState(),renderAll(),setStatus(`Imported. Cards: ${state.cards.length}. Words: ${Object.keys(state.lexicon).length}.`)}catch(e){setStatus("Import failed: invalid JSON format.","danger")}},n.readAsText(e)}function resetAll(){confirm("Delete all local Sentence Cards data in this browser?")&&(localStorage.removeItem(STORAGE_KEY),state=emptyState(),reviewSession=null,resetCaptureDraft(),renderAll(),setStatus("Local data cleared."))}function openEditDialog(e){const t=byId(e);if(!t)return;const n=$("#editDialog");$("#editId").value=t.id,$("#editSentence").value=t.sentence,$("#editSource").value=t.source,$("#editTranslation").value=t.translation,$("#editNotes").value=t.notes,renderEditWords(t),"function"==typeof n.showModal?n.showModal():n.setAttribute("open","open")}function closeEditDialog(){const e=$("#editDialog");"function"==typeof e.close?e.close():e.removeAttribute("open")}function buildEditWordList(e,t){const n=suggestWords(e),a=new Set(t),r=[...t];for(const e of n)a.has(e)||(r.push(e),a.add(e));return r}function renderEditWords(e){const t=$("#editWords");t.textContent="";const n=buildEditWordList(e.sentence,e.targets);if(0===n.length){const e=document.createElement("div");return e.className="panel-sub",e.textContent="No target words. Add some below.",void t.appendChild(e)}for(const a of n){const n=document.createElement("div");n.className="word-row",n.dataset.word=a;const r=document.createElement("input");r.type="checkbox",r.checked=e.targets.includes(a),r.dataset.word=a,r.className="edit-word-check";const s=document.createElement("div"),o=document.createElement("div");o.className="w",o.textContent=a;const i=document.createElement("div");i.className="meta";const d=guessPos(a),l=state.lexicon[a]?.translation?"lex":"";i.textContent=[d,l].filter(Boolean).join(" ")||" ";const c=document.createElement("div");c.className="mini-links";const u=document.createElement("a");u.className="mini-link",u.href=buildCambridgeEnZhUrl(a),u.target="_blank",u.rel="noopener noreferrer",u.textContent="Cambridge";const m=document.createElement("a");m.className="mini-link",m.href=buildGoogleTranslateUrl(a,{sl:"en",tl:TARGET_LANG_GOOGLE}),m.target="_blank",m.rel="noopener noreferrer",m.textContent="Translate",c.appendChild(u),c.appendChild(m),s.appendChild(o),s.appendChild(i),s.appendChild(c);const p=document.createElement("input");p.type="text",p.placeholder="translation (optional)",p.value=state.lexicon[a]?.translation||"",p.dataset.word=a,p.className="edit-word-translation",n.appendChild(r),n.appendChild(s),n.appendChild(p),t.appendChild(n)}}function editSave(){const e=byId($("#editId").value);if(!e)return;e.sentence=stableTrim($("#editSentence").value),e.source=stableTrim($("#editSource").value),e.translation=stableTrim($("#editTranslation").value),e.notes=stableTrim($("#editNotes").value),e.updatedAt=now();const t=[];for(const e of document.querySelectorAll("#editWords .word-row")){const n=e.dataset.word,a=e.querySelector('input[type="checkbox"]'),r=e.querySelector('input[type="text"]');a?.checked&&t.push(n);const s=stableTrim(r?.value||"");s&&upsertLexicon(n,s)}e.targets=t.map(normalizeWord).filter(Boolean),saveState(),closeEditDialog(),renderAll(),setStatus("Card updated.")}function editDelete(){const e=$("#editId").value;if(!byId(e))return;confirm("Delete this card?")&&(state.cards=state.cards.filter(t=>t.id!==e),saveState(),closeEditDialog(),renderAll(),setStatus("Card deleted."))}function editReviewNow(){const e=byId($("#editId").value);e&&(e.srs.dueAt=now()-1,e.updatedAt=now(),saveState(),closeEditDialog(),setRoute("review"),startReview())}function addWordToCapture(e){e.preventDefault();const t=stableTrim($("#addWordText").value),n=stableTrim($("#addWordTrans").value),a=normalizeWord(t);a&&/^[a-z]+(?:'[a-z]+)*$/.test(a)?(captureDraft[a]||captureManualOrder.push(a),setCaptureWord(a,{manual:!0,checked:!0,translation:n||state.lexicon[a]?.translation||""}),$("#addWordText").value="",$("#addWordTrans").value="",renderSuggestedWords()):setStatus("Invalid word. Use letters and apostrophe only.","danger")}function addWordToEdit(e){e.preventDefault();const t=stableTrim($("#editAddWordText").value),n=stableTrim($("#editAddWordTrans").value),a=normalizeWord(t);if(!a||!/^[a-z]+(?:'[a-z]+)*$/.test(a))return void setStatus("Invalid word. Use letters and apostrophe only.","danger");n&&upsertLexicon(a,n),$("#editAddWordText").value="",$("#editAddWordTrans").value="";const r=byId($("#editId").value);r&&(r.targets.includes(a)||r.targets.push(a),renderEditWords(r),saveState(),renderAll())}function renderAll(){rebuildSuggestionsFromSentence(),renderReviewStats(),renderReview(),renderDeck(),renderLexicon(),updateFooter()}function updateFooter(){const e=getDueCards().length;setStatus(`Cards: ${state.cards.length}. Due: ${e}. Words: ${Object.keys(state.lexicon).length}.`)}function wireEvents(){for(const e of document.querySelectorAll(".tab"))e.addEventListener("click",()=>setRoute(e.dataset.route));window.addEventListener("hashchange",()=>setRoute(currentRoute(),!1)),$("#captureForm").addEventListener("submit",captureSaveCards),$("#captureClear").addEventListener("click",clearCaptureForm),$("#captureSentence").addEventListener("input",()=>rebuildSuggestionsFromSentence({keepTranslations:!0})),$("#captureSentence").addEventListener("keydown",e=>{(e.ctrlKey||e.metaKey)&&"Enter"===e.key&&captureSaveCards(e)}),$("#suggestedWords").addEventListener("change",e=>{const t=e.target;if(t instanceof HTMLElement&&t.classList.contains("word-check")){setCaptureWord(t.dataset.word,{checked:t.checked})}}),$("#suggestedWords").addEventListener("input",e=>{const t=e.target;if(t instanceof HTMLElement&&t.classList.contains("word-translation")){setCaptureWord(t.dataset.word,{translation:t.value})}}),$("#wordsSelectAll").addEventListener("click",()=>{for(const e of Object.keys(captureDraft))setCaptureWord(e,{checked:!0});renderSuggestedWords()}),$("#wordsSelectNone").addEventListener("click",()=>{for(const e of Object.keys(captureDraft))setCaptureWord(e,{checked:!1});renderSuggestedWords()}),$("#wordsFromLexicon").addEventListener("click",()=>rebuildSuggestionsFromSentence({keepTranslations:!0})),$("#wordsAutoTranslate")?.addEventListener("click",()=>{runTranslateTask(async()=>{const e=collectCaptureTargets();if(0===e.length)return void setStatus("No selected words to translate.","danger");setStatus(`Auto-translating ${e.length} words (online)...`);let t=0,n=0;for(const a of e){if(stableTrim(captureDraft[a]?.translation||""))n+=1;else try{const e=await myMemoryTranslate(a,{from:"en",to:TARGET_LANG_GOOGLE});setCaptureWord(a,{translation:e}),upsertLexicon(a,e),t+=1}catch(e){}}saveState(),renderSuggestedWords(),setStatus(`Auto-translate done. Added ${t}, skipped ${n}.`)})}),$("#addWordForm").addEventListener("submit",addWordToCapture),$("#loadSampleDeck")?.addEventListener("click",loadSampleDeckIntermediate),$("#captureAutoTranslateSentence")?.addEventListener("click",()=>{runTranslateTask(async()=>{const e=stableTrim($("#captureSentence").value);if(e){setStatus("Auto-translating sentence (online)...");try{const t=await myMemoryTranslate(e,{from:"en",to:TARGET_LANG_GOOGLE});$("#captureTranslation").value=t,setStatus("Sentence translation filled.")}catch(t){setStatus("Auto-translate failed. Opening Google Translate instead.","danger"),openExternal(buildGoogleTranslateUrl(e,{sl:"en",tl:TARGET_LANG_GOOGLE}))}}else setStatus("Paste a sentence first, then translate.","danger")})}),$("#openTranslateSentenceGoogle")?.addEventListener("click",()=>{const e=stableTrim($("#captureSentence").value);e?openExternal(buildGoogleTranslateUrl(e,{sl:"en",tl:TARGET_LANG_GOOGLE})):setStatus("Paste a sentence first, then translate.","danger")}),$("#openTranslateSentenceBing")?.addEventListener("click",()=>{const e=stableTrim($("#captureSentence").value);e?openExternal(buildBingTranslateUrl(e,{from:"en",to:TARGET_LANG_BING})):setStatus("Paste a sentence first, then translate.","danger")}),$("#reviewStart").addEventListener("click",()=>startReview({shuffle:!1})),$("#reviewShuffle").addEventListener("click",()=>startReview({shuffle:!0})),$("#reviewReveal").addEventListener("click",revealAnswer),$("#reviewTranslateGoogle")?.addEventListener("click",()=>{const e=currentReviewCard(),t=stableTrim(e?.sentence||"");t?openExternal(buildGoogleTranslateUrl(t,{sl:"en",tl:TARGET_LANG_GOOGLE})):setStatus("No card loaded to translate.","danger")}),$("#reviewTranslateBing")?.addEventListener("click",()=>{const e=currentReviewCard(),t=stableTrim(e?.sentence||"");t?openExternal(buildBingTranslateUrl(t,{from:"en",to:TARGET_LANG_BING})):setStatus("No card loaded to translate.","danger")}),$("#reviewEditCard")?.addEventListener("click",()=>{const e=currentReviewCard();e?openEditDialog(e.id):setStatus("No card loaded to edit.","danger")}),$("#reviewAutoSentence")?.addEventListener("click",()=>{runTranslateTask(async()=>{const e=currentReviewCard();if(!e)return void setStatus("No card loaded to translate.","danger");const t=stableTrim(e.sentence);if(t){setStatus("Auto-translating sentence (online)...");try{const n=await myMemoryTranslate(t,{from:"en",to:TARGET_LANG_GOOGLE});e.translation=n,e.updatedAt=now(),saveState(),renderReview(),setStatus("Sentence translation saved to this card.")}catch(e){setStatus("Auto-translate failed. Use 'Translate sentence' to open Google Translate.","danger")}}else setStatus("This card has no sentence.","danger")})}),$("#reviewAutoWords")?.addEventListener("click",()=>{runTranslateTask(async()=>{const e=currentReviewCard();if(!e)return void setStatus("No card loaded to translate.","danger");const t=Array.isArray(e.targets)?e.targets:[];if(0===t.length)return void setStatus("This card has no target words.","danger");const n=t.filter(e=>!stableTrim(state.lexicon[e]?.translation||""));if(0===n.length)return void setStatus("All target words already have translations.");setStatus(`Auto-translating ${n.length} words (online)...`);let a=0;for(const e of n)try{upsertLexicon(e,await myMemoryTranslate(e,{from:"en",to:TARGET_LANG_GOOGLE})),a+=1}catch(e){}saveState(),renderReview(),setStatus(`Saved ${a} word translations to Lexicon.`)})}),$("#reviewGrade").addEventListener("click",e=>{const t=e.target;if(!(t instanceof HTMLElement))return;const n=t.dataset.grade;n&&gradeCurrent(n)}),document.addEventListener("keydown",e=>{if("review"===currentRoute())if(" "!==e.key&&"Space"!==e.code)reviewSession?.revealed&&("1"===e.key&&gradeCurrent("again"),"2"===e.key&&gradeCurrent("hard"),"3"===e.key&&gradeCurrent("good"),"4"===e.key&&gradeCurrent("easy"));else{if(e.preventDefault(),!reviewSession)return;reviewSession.revealed||revealAnswer()}}),$("#deckSearch").addEventListener("input",renderDeck),$("#deckDueOnly").addEventListener("click",()=>setDeckDueOnly(!0)),$("#deckAll").addEventListener("click",()=>setDeckDueOnly(!1)),$("#deckList").addEventListener("click",e=>{const t=e.target;if(!(t instanceof HTMLElement))return;const n=t.dataset.action;if(!n)return;const a=t.closest(".deck-item"),r=a?.dataset.id;if(r){if("edit"===n&&openEditDialog(r),"delete"===n){if(!confirm("Delete this card?"))return;state.cards=state.cards.filter(e=>e.id!==r),saveState(),renderAll()}if("reviewNow"===n){const e=byId(r);if(!e)return;e.srs.dueAt=now()-1,e.updatedAt=now(),saveState(),setRoute("review"),startReview()}}}),$("#lexSearch").addEventListener("input",renderLexicon),$("#lexExport").addEventListener("click",exportLexiconCsv),$("#exportJson").addEventListener("click",exportJson),$("#importRun").addEventListener("click",importJsonRun),$("#resetAll").addEventListener("click",resetAll),$("#editSave").addEventListener("click",editSave),$("#editDelete").addEventListener("click",editDelete),$("#editReviewNow").addEventListener("click",editReviewNow),$("#editWords").addEventListener("change",e=>{const t=e.target;if(!(t instanceof HTMLElement))return;if(!t.classList.contains("edit-word-translation"))return;const n=t.dataset.word,a=stableTrim(t.value);a&&upsertLexicon(n,a),saveState(),renderLexicon()}),$("#editAddWordForm").addEventListener("submit",addWordToEdit),$("#gotoToday").addEventListener("click",()=>{setRoute("review"),startReview({shuffle:!1})})}function boot(){wireEvents(),setRoute(currentRoute(),!1),rebuildSuggestionsFromSentence(),renderAll(),"serviceWorker"in navigator&&navigator.serviceWorker.register("./sw.js",{scope:"./"}).catch(()=>{})}
const STORAGE_KEY="sentence_cards_v1",TARGET_LANG_GOOGLE="zh-CN",TARGET_LANG_BING="zh-Hans",MYMEMORY_ENDPOINT="https://api.mymemory.translated.net/get",STOPWORDS=new Set(["a","about","above","after","again","against","all","am","an","and","any","are","aren't","as","at","be","because","been","before","being","below","between","both","but","by","can","can't","cannot","could","couldn't","did","didn't","do","does","doesn't","doing","don't","down","during","each","few","for","from","further","had","hadn't","has","hasn't","have","haven't","having","he","he'd","he'll","he's","her","here","here's","hers","herself","him","himself","his","how","how's","i","i'd","i'll","i'm","i've","if","in","into","is","isn't","it","it's","its","itself","let's","me","more","most","mustn't","my","myself","no","nor","not","of","off","on","once","only","or","other","ought","our","ours","ourselves","out","over","own","same","shan't","she","she'd","she'll","she's","should","shouldn't","so","some","such","than","that","that's","the","their","theirs","them","themselves","then","there","there's","these","they","they'd","they'll","they're","they've","this","those","through","to","too","under","until","up","very","was","wasn't","we","we'd","we'll","we're","we've","were","weren't","what","what's","when","when's","where","where's","which","while","who","who's","whom","why","why's","will","won't","with","would","wouldn't","you","you'd","you'll","you're","you've","your","yours","yourself","yourselves"]),DAY_MS=864e5,MAX_SUGGESTED_WORDS=40,$=e=>document.querySelector(e),SAMPLE_SENTENCES_INTERMEDIATE_V1=["I kept putting it off until the deadline forced my hand.","She took it personally, even though it wasn't about her.","The plan sounds good on paper, but it might fall apart in practice.","I ran into an old friend on the subway, and we talked for an hour.","Once you get the hang of it, the process is pretty straightforward.","I don't want to jump to conclusions without the full context.","Let's break the problem down into smaller, manageable steps.","He apologized, but his tone made it feel half-hearted.","I backed up my files just in case something went wrong.","The meeting dragged on because no one wanted to make a decision.","This feature is useful, but it comes with a trade-off in performance.","She is meticulous about details, which saves us from painful mistakes.","I tried to cut corners, and it ended up costing me more time.","The instructions were vague, so I figured it out by trial and error.","We should prioritize what matters instead of reacting to every message.","If you can spare five minutes, I would appreciate your feedback.","He raised a valid concern, so we adjusted the timeline.","The data points to a trend, but the sample size is still small.","I was tempted to quit, but I decided to stick with it.","By and large, people respond well when you set clear expectations.","I don't agree with the approach, but I understand the reasoning behind it.","The new policy is meant to reduce friction, not add bureaucracy.","She handled the criticism with grace and a sense of humor.","I made a mental note to follow up after the call.","The result was unexpected, but it makes sense in hindsight.","We reached a compromise that everyone could live with.","He tends to overpromise, which puts the team in a tough spot.","I couldn't focus until I cleared my desk and my mind.","The app is simple to use, yet powerful enough for daily study.","I want to sound natural, not perfect.","The explanation was clear, but the example made it click.","I keep a list of phrases that I want to borrow in my own writing.","If I had started earlier, I wouldn't be rushing right now.","She asked for help, which took a lot of courage.","The more you listen, the more nuances you start to notice.",'I learned to say "I don\'t know" without feeling embarrassed.',"This habit is hard to build, but easy to lose.","The idea is compelling, but we should test it before we commit.","I don't want to waste your time, so I'll get straight to the point.","When something feels off, it's worth investigating instead of ignoring it.","I came across a phrase that perfectly captured what I meant.","He toned down his opinion after hearing the other side.","Don't take it for granted that people know what you want.","I had to put up with a few glitches before it stabilized.","She stepped up when things got messy.",'I don\'t want to settle for "good enough" if we can do better.',"The sooner we align on goals, the smoother the project will go.","I rewrote the sentence until it sounded like something I'd actually say.","I prefer to learn in context rather than memorize isolated vocabulary.","It took a few tries, but eventually it worked out."],translationCache=new Map;let translateBusy=!1;const ROUTES=["capture","review","deck","io","about"];let state=loadState(),captureDraft={},captureManualOrder=[],deckDueOnly=!1,reviewSession=null;boot();